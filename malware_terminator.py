from base64 import b64decode
from subprocess import DEVNULL, run
from sys import argv
from loguru import logger


def publish_commit():
    logger.info("Running commmit.")
    run(["git", "add", "tokens.txt", "webhooks.txt"], stdout=DEVNULL)
    run(["git", "commit", "-m", "adding item."], stdout=DEVNULL)

    logger.info("Running push.")
    run(
        ["git", "push", "--set-upstream", "origin", "master", "--force"], stdout=DEVNULL
    )

    logger.success("Done!!")


def main(input_arg: str):
    valid_arg = False
    if not input_arg.startswith("http"):
        logger.info("bot token detected.")
        user_id = input_arg.split(".")[0]
        if b64decode(user_id + '=' * (-len(user_id) % 4)).decode().isdigit():
            with open("tokens.txt", "a+") as file:
                file.write(input_arg.strip() + "\n")

            valid_arg = True
    else:
        if "webhooks" in input_arg:
            logger.info("Webhook detected.")
            with open("webhooks.txt", "a+") as file:
                file.write(input_arg.strip() + "\n")

            valid_arg = True

    if valid_arg:
        publish_commit()


if __name__ == "__main__":
    input_arg = argv[1]
    main(input_arg)
